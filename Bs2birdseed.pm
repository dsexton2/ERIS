#! /usr/bin/perl -w

=head1 NAME

Concordance::Bs2birdseed - converts .bs to .birdseed

=head1 SYNOPSIS

 use Concordance::Bs2birdseed;
 my $bs_2_birdseed = Concordance::Bs2birdseed->new;
 $bs_2_birdseed->config(%config);
 $bs_2_birdseed->convert_bs_to_birdseed;
 $bs_2_birdseed->move_birdseed_to_project_dir;

=head1 DESCRIPTION

This script converts the .bs files generated by buildGELI.pl into .birdseed files, writing out only the desired columns from the input.  It then moves the .birdseed files to the project directory.

=head2 Methods

=over 12

=item C<new>

Returns a new Concordance::Bs2birdseed object.

=item C<config>

Gets or sets and gets the General::Config object.

=item C<convert_bs_to_birdseed>

Converts each .bs file in a specified directory to a .birdseed.

=item C<move_birdseed_to_project_dir>

Tests for the existence of the project directory and creates it if necessary, then moves the .birdseed files there.

=back

=head1 LICENSE

This script is the property of Baylor College of Medicine.

=head1 AUTHOR

Updated by John McAdams - L<mailto:mcadams@bcm.edu>

=cut

package Concordance::Bs2birdseed;

use strict;
use warnings;
use Config::General;
use File::Copy;
use Log::Log4perl;

my $error_log = Log::Log4perl->get_logger("errorLogger");
my $debug_log = Log::Log4perl->get_logger("debugLogger");

sub new {
	my $self = {};
	$self->{CONFIG} = ();
	$self->{PATH} = undef;
	bless($self);
	return $self;
}

sub config {
	my $self = shift;
	if (@_) { %{ $self->{CONFIG} } = @_; }
	return %{ $self->{CONFIG} };
}

sub _get_file_list_ {
	my $self = shift;
	my %config = $self->config;
	my $file_extension = "";
	if (@_) { $file_extension = shift; }
	my @files = glob($config{"birdseed_dir"}."/*".$file_extension);
	my $size = @files;

	if ($size == 0) {
		$error_log->error("no ".$file_extension." files found in ".$config{"birdseed_dir"}."\n");
		exit;
	}
	return @files;
}

sub convert_bs_to_birdseed {
	my $self = shift;
	my @files=$self->_get_file_list_(".bs");
	my $size = @files;

	foreach my $file (@files) {
		my @a=split(/\./,$file);
		my $outfile=$a[0].".birdseed";
		$debug_log->debug("Converting $file to $outfile\n");
		open(FOUT,"> $outfile");
		open(FIN,"$file");
		while (<FIN>) {
			chomp;
			if (/^\[/ || /^\@/) {
				# do nothing
			} else {
				@a=split(/\s+/);
				print FOUT "$a[0]\t$a[1]\t$a[2]\t$a[5]\n";
			}
		}
		close(FIN);
		close(FOUT);
	}
}

sub move_birdseed_to_project_dir {
	my $self = shift;
	my %config = $self->config;
	if (-e $config{"birdseed_dir"}) {
		my @files = $self->_get_file_list_(".birdseed");
		foreach my $file (@files) {
			move($file, $config{"birdseed_dir"}."/".$config{"project_name"});
		}
	}
}

1;
